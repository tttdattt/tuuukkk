<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>youtube見ながらゲーム！</title>
    <style>
        :root { --accent: #a29bfe; --bg: #030305; --panel: rgba(20, 20, 25, 0.98); --glass: rgba(255, 255, 255, 0.08); }
        body { margin: 0; overflow: hidden; background: var(--bg); color: white; font-family: 'Inter', -apple-system, sans-serif; width: 100vw; height: 100vh; }
        
        .container { 
            display: flex; width: 100%; height: 100%; 
            padding: 25px; box-sizing: border-box; gap: 25px;
            background: radial-gradient(circle at center, #11111d 0%, #030305 100%);
        }

        .side { 
            flex: 1; height: 100%; position: relative; 
            background: #000; border-radius: 35px; border: 1px solid var(--glass);
            overflow: hidden; box-shadow: 0 30px 60px rgba(0,0,0,0.8);
        }

        /* YouTube側のレイアウト修正：上部にスペースを確保 */
        .video-side { display: flex; flex-direction: column; }
        .control-header { 
            height: 80px; 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            padding: 0 20px; 
            background: rgba(255,255,255,0.02);
            border-bottom: 1px solid var(--glass);
        }
        .video-wrapper { flex: 1; background: #000; position: relative; }
        iframe { width: 100%; height: 100%; border: none; }

        input { background: rgba(0,0,0,0.5); border: 1px solid var(--glass); color: white; padding: 12px; border-radius: 12px; outline: none; font-size: 0.8rem; flex: 1; }
        .btn-action { padding: 12px 18px; border-radius: 12px; border: none; cursor: pointer; font-size: 0.7rem; font-weight: bold; transition: 0.3s; color: white; white-space: nowrap; }
        .btn-paste { background: rgba(255,255,255,0.1); }
        .btn-play { background: var(--accent); color: #000; }

        /* ゲーム側UI */
        .game-nav { position: absolute; top: 20px; left: 20px; display: flex; flex-direction: column; gap: 12px; z-index: 5; }
        .ctrl-btn { background: rgba(255,255,255,0.1); border: 1px solid var(--glass); color: white; padding: 10px 15px; border-radius: 12px; cursor: pointer; backdrop-filter: blur(10px); transition: 0.2s; font-size: 0.65rem; }
        .ctrl-btn.active { background: #55efc4; color: #000; }
        .game-ui { position: absolute; top: 20px; right: 20px; text-align: right; pointer-events: none; z-index: 5; }
        .score { font-size: 4rem; font-weight: 100; color: var(--accent); line-height: 1; }
        
        /* 共通設定パネル */
        .settings-trigger { position: fixed; top: 40px; right: 40px; z-index: 150; width: 50px; height: 50px; border-radius: 50%; background: var(--panel); display: flex; align-items: center; justify-content: center; cursor: pointer; border: 1px solid var(--glass); }
        .side-panel { position: fixed; top: 0; right: -420px; width: 380px; height: 100%; background: var(--panel); z-index: 110; transition: 0.5s; padding: 100px 30px; border-left: 1px solid var(--glass); box-sizing: border-box; }
        .side-panel.open { right: 0; }
        .playlist-scroll { flex: 1; overflow-y: auto; margin-top: 20px; display: flex; flex-direction: column; gap: 10px; }
    </style>
</head>
<body>

<div class="container">
    <div class="side video-side">
        <div class="control-header">
            <input type="text" id="main-url" placeholder="YouTube URLをここに貼り付け...">
            <button class="btn-action btn-paste" onclick="quickPaste('main-url')">PASTE</button>
            <button class="btn-action btn-play" onclick="loadFrom('main-url')">PLAY</button>
        </div>
        <div class="video-wrapper">
            <iframe id="player" src="about:blank" allow="autoplay; encrypted-media" allowfullscreen></iframe>
        </div>
    </div>

    <div class="side game-side" id="game-container">
        <div class="game-nav">
            <button id="toggleGame" class="ctrl-btn" onclick="toggleGameState()">START</button>
            <button class="ctrl-btn" onclick="resetGame()">RESET</button>
        </div>
        <div class="game-ui">
            <div class="score" id="score">0</div>
            <div id="distance" style="opacity:0.5; font-size:0.8rem;">0m</div>
        </div>
        <canvas id="canvas"></canvas>
    </div>
</div>

<div class="settings-trigger" id="gearBtn" onclick="togglePanel()">⚙️</div>

<div class="side-panel" id="sidePanel">
    <h3 style="letter-spacing:2px;">STORAGE</h3>
    <input type="text" id="panel-url" placeholder="URLを保存...">
    <div style="display:flex; gap:5px; margin-top:10px;">
        <select id="target-list" style="flex:1; background:#000; color:white; border-radius:5px; border:1px solid var(--glass);"></select>
        <button class="btn-action btn-play" onclick="saveToPlaylist()">ADD</button>
    </div>
    <div class="playlist-scroll" id="playlistArea"></div>
</div>

<script>
    // システム系
    const STORAGE_KEY = 'dat_yt_hub_v6';
    let db = JSON.parse(localStorage.getItem(STORAGE_KEY)) || Array.from({length: 5}, (_, i) => ({ name: `List ${i+1}`, vids: [] }));

    function saveDB() { localStorage.setItem(STORAGE_KEY, JSON.stringify(db)); renderUI(); }
    function togglePanel() { document.getElementById('sidePanel').classList.toggle('open'); }

    function extractID(url) {
        const reg = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=|live\/)([^#\&\?]*).*/;
        const match = url.match(reg);
        return (match && match[2].length === 11) ? match[2] : (url.length === 11 ? url : null);
    }

    function loadFrom(inputId) {
        const id = extractID(document.getElementById(inputId).value.trim());
        if(id) document.getElementById('player').src = `https://www.youtube.com/embed/${id}?autoplay=1&mute=1&rel=0`;
    }

    async function quickPaste(id) { 
        const text = await navigator.clipboard.readText(); 
        document.getElementById(id).value = text; 
    }

    function renderUI() {
        const area = document.getElementById('playlistArea');
        const sel = document.getElementById('target-list');
        area.innerHTML = ''; sel.innerHTML = '';
        db.forEach((list, i) => {
            const opt = document.createElement('option'); opt.value = i; opt.innerText = list.name;
            sel.appendChild(opt);
            const card = document.createElement('div');
            card.innerHTML = `<h4 style="color:var(--accent); font-size:0.7rem;">${list.name}</h4>`;
            list.vids.forEach(vid => {
                const item = document.createElement('div');
                item.style.fontSize = '0.7rem'; item.style.padding = '5px';
                item.innerText = `ID: ${vid}`;
                item.onclick = () => { document.getElementById('player').src = `https://www.youtube.com/embed/${vid}?autoplay=1&mute=1`; };
                card.appendChild(item);
            });
            area.appendChild(card);
        });
    }
    function saveToPlaylist() {
        const id = extractID(document.getElementById('panel-url').value);
        if(id) { db[document.getElementById('target-list').value].vids.push(id); saveDB(); }
    }

    // ゲーム系：ドットハイウェイ回避
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const container = document.getElementById('game-container');
    let w, h, score = 0, isGameRunning = false, dist = 0;
    let player = { x: 0, y: 0, w: 40, h: 70 };
    let enemies = [];
    let lanes = [];

    function init() {
        w = canvas.width = container.clientWidth;
        h = canvas.height = container.clientHeight;
        player.x = w / 2 - player.w / 2;
        player.y = h - 120;
        lanes = [w*0.2, w*0.4, w*0.6, w*0.8];
    }
    window.addEventListener('resize', init);
    init();

    canvas.addEventListener('mousemove', (e) => {
        if(!isGameRunning) return;
        const rect = canvas.getBoundingClientRect();
        player.x = (e.clientX - rect.left) - player.w / 2;
    });

    function toggleGameState() {
        isGameRunning = !isGameRunning;
        document.getElementById('toggleGame').innerText = isGameRunning ? 'PAUSE' : 'START';
        document.getElementById('toggleGame').classList.toggle('active', isGameRunning);
    }

    function spawnEnemy() {
        if(!isGameRunning) return;
        const lane = lanes[Math.floor(Math.random() * lanes.length)];
        enemies.push({ x: lane - 20, y: -100, w: 40, h: 70, speed: 5 + (dist/1000) });
        setTimeout(spawnEnemy, Math.max(300, 800 - (dist/200)));
    }

    function resetGame() {
        score = 0; dist = 0; enemies = [];
        document.getElementById('score').innerText = "0";
        document.getElementById('distance').innerText = "0m";
    }

    function animate() {
        ctx.fillStyle = '#050508';
        ctx.fillRect(0, 0, w, h);

        // 背景のライン
        ctx.strokeStyle = 'rgba(255,255,255,0.05)';
        lanes.forEach(l => {
            ctx.beginPath(); ctx.moveTo(l, 0); ctx.lineTo(l, h); ctx.stroke();
        });

        if(isGameRunning) {
            dist++;
            document.getElementById('distance').innerText = `${Math.floor(dist/10)}m`;

            // 自機描画 (GTR風シルエット)
            ctx.fillStyle = varColor('--accent');
            ctx.shadowBlur = 15; ctx.shadowColor = varColor('--accent');
            ctx.fillRect(player.x, player.y, player.w, player.h);
            ctx.fillStyle = '#fff'; ctx.fillRect(player.x+5, player.y+10, 30, 15); // ガラス

            // 敵車両
            enemies.forEach((en, i) => {
                en.y += en.speed;
                ctx.fillStyle = '#ff7675';
                ctx.shadowColor = '#ff7675';
                ctx.fillRect(en.x, en.y, en.w, en.h);
                
                // 衝突判定
                if (player.x < en.x + en.w && player.x + player.w > en.x && player.y < en.y + en.h && player.y + player.h > en.y) {
                    isGameRunning = false;
                    alert("CRASH! Score: " + score);
                    resetGame();
                    toggleGameState();
                }

                if(en.y > h) {
                    enemies.splice(i, 1);
                    score += 10;
                    document.getElementById('score').innerText = score;
                }
            });
            ctx.shadowBlur = 0;
        }
        requestAnimationFrame(animate);
    }

    function varColor(name) { return getComputedStyle(document.documentElement).getPropertyValue(name); }

    renderUI(); animate(); spawnEnemy();
</script>
</body>
</html>